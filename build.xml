<?xml version="1.0"?>

<project name="mysqlDiff" default="dist">
    <!-- local properties, scala.home for example -->
    <property file="build.properties"/>
    <property file="${user.home}/build.local.properties"/>

    <property name="scala-library.jar" value="${scala.home}/lib/scala-library.jar"/>
    
    <property name="jar.suffix" value=""/>

    <target name="init">
        <echo>scala.home=${scala.home}</echo>
        
        <path id="build.classpath">
            <pathelement location="${scala-library.jar}"/>
            <fileset dir="lib" includes="**/*.jar"/>
        </path>

        <taskdef resource="scala/tools/ant/antlib.xml">
            <classpath>
                <pathelement location="${scala.home}/lib/scala-compiler.jar"/>
                <pathelement location="${scala-library.jar}"/>
            </classpath>
        </taskdef>
    </target>

    <target name="compile" depends="init">
        <mkdir dir="target/classes"/>
        <scalac srcdir="src/main/scala" destdir="target/classes"
                deprecation="on" unchecked="on" encoding="UTF-8"
                classpathref="build.classpath" force="changed"/>
    </target>

    <target name="run-tests" depends="clean, compile">
        <java classname="ru.yandex.mysqlDiff.MysqlDiffTest" failonerror="true">
            <sysproperty key="java.awt.headless" value="true"/>
            <classpath refid="build.classpath"/>
            <classpath>
                <pathelement location="target/classes"/>
                <pathelement location="${scala-library.jar}"/>
            </classpath>
        </java>
    </target>
    
    <target name="do-jar">
        <jar jarfile="target/yandex-mysql-diff${jar.suffix}.jar" index="true">
            <fileset dir="target/classes"/>
        </jar>
    </target>
    
    <target name="do-jar-jar" depends="do-jar">
        <taskdef name="jarjar" classname="com.tonicsystems.jarjar.JarJarTask"
                classpath="lib/jarjar-1.0rc7.jar"/>
        
        <jarjar jarfile="target/yandex-mysql-diff-standalone${jar.suffix}.jar" index="true">
            <fileset dir="target/classes"/>
            <zipgroupfileset dir="./lib">
                <include name="mysql*.jar"/>
                <include name="scalax*.jar"/>
            </zipgroupfileset>
            <zipfileset src="${scala-library.jar}"/>
            <rule pattern="scalax.**" result="ru.yandex.mysqlDiff.dep.@0"/>
            <rule pattern="com.**" result="ru.yandex.mysqlDiff.dep.@0"/>
            <rule pattern="org.**" result="ru.yandex.mysqlDiff.dep.@0"/>
            <rule pattern="scala.**" result="ru.yandex.mysqlDiff.dep.@0"/>
        </jarjar>
    </target>

    <target name="jar" depends="compile, do-jar"/>

    <target name="do-dist" depends="do-jar, do-jar-jar">
        <mkdir dir="target/dist/mysql-diff"/>
        <mkdir dir="target/dist/mysql-diff/bin"/>
        <mkdir dir="target/dist/mysql-diff/lib"/>
        <copy file="target/yandex-mysql-diff${jar.suffix}.jar" todir="target/dist/mysql-diff/lib"/>
        <copy file="src/main/bin/mysql-diff" todir="target/dist/mysql-diff/bin"/>

        <chmod file="target/dist/mysql-diff/bin/mysql-diff" perm="ugo+rx"/>

        <tar destfile="target/mysql-diff.tar.gz" compression="gzip">
            <tarfileset dir="target/dist/mysql-diff/bin/../.." mode="555">
                <include name="mysql-diff/bin/*"/>
            </tarfileset>
            <tarfileset dir="target/dist/mysql-diff/lib/../.." mode="444">
                <include name="mysql-diff/lib/*"/>
            </tarfileset>
        </tar>
    </target>

    <target name="dist" depends="clean,jar,do-dist"/>
    
    <!-- for depot-scripts -->
    <target name="build" depends="dist"/>

    <target name="clean">
        <delete dir="target"/>
    </target>
</project>

<!-- vim: set ts=4 sw=4 et: -->
